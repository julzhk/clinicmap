<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Simple map of centres</title>
    <style>
      html, body, #map-canvas {
        height: 100%;
        margin: 0px;
        padding: 0px
      }
        .filter .check, .filter .check_num { padding-right: 2em;
        }
    </style>
      <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.2/underscore-min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=true"></script>
    <script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
    <script src="map_data.js"></script>
    <script src="colour_data.js"></script>
    <script src="sponsors.js"></script>
    <script>
        function make_marker(latitude, longitude, label, map) {
            return new google.maps.Marker(
                    {
                        position: new google.maps.LatLng(latitude, longitude),
                        map: map,
                        title: label
                    }
            );
        };
        function generate_colour(label) {
            i = _.indexOf(major_sponsor, label, false);
            if (i==-1){i=1}

            colour = colorlist[i]
            return colour;
        };

        function make_circle(latitude, longitude, label, map, size ) {

            var position = new google.maps.LatLng(latitude, longitude);
            circle = new google.maps.Circle({
              strokeColor: '#000',
              strokeOpacity: 0.4,
              strokeWeight: 1,
              fillColor: generate_colour(label),
              fillOpacity: 0.75,
              labelClass:label,
              map: map,
              center: position,
              radius: 50000+ (20000*size)
            });
            var infowindow = new google.maps.InfoWindow({
                content: label,
                position:position
            });
            google.maps.event.addListener(circle, 'click', function() {
                infowindow.open(map,circle);
            });

            return circle;
        }
        function google_map_initialize() {


            map_points = _.map(mapdata,
                    function(arr){
                        return make_circle(
                                arr[0],
                                arr[1] ,
                                arr[2] ,
                                map,
                                arr[3]
                        )
                    }
            )
        }

    </script>
    <script>
        var map_points = [];
        $( document ).ready(function() {
            var mapCentre = new google.maps.LatLng(13.82916,20.8324);
            var mapOptions = {zoom: 4,center: mapCentre}
            map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);


            _.map(major_sponsor, function(org_name,k){
                colr  = colorlist[k];
                swatch = '<span style="background-color:'+colr + '; width:2em;">&nbsp;&nbsp;</span>';
                $( ".filter" ).append(swatch +  '<span class="check"><input type="checkbox" checked="checked" ' +
                             ' value="'+org_name+ '">'+org_name +'</span>' );
                        });
            $( ".filter" ).append('<br> Filter by number of sponsors: ');
            _.map(_.range(9), function(num,key){
                $( ".filter" ).append('<span class="check_num"><input type="checkbox" checked="checked" ' +
                                     ' value="'+num + '">'+ num  +'</span>' );
                        });

            google_map_initialize();
//            listen for changes in checkboxes (label filters)
          $('input[type=checkbox]').change(function(){
                    var checkval=$(this).val();
                    var filtered_map_points = _.filter(map_points,
                                                    function(pt){
                                                        return pt.labelClass.indexOf(checkval) > -1
                                                    });
                     if (this.checked) {_.map(filtered_map_points,function(pt) {
//                                console.log('checked');
                                pt.setMap(map);
                            });
                        } else {
                         _.map(filtered_map_points,
                            function(pt) {
                                pt.setMap(null);
                            })}
                })
            //            listen for changes in checkboxes (label filters)
          $('.check_num input[type=checkbox]').change(function() {
              var checkval = $(this).val();
              console.log('num checked');
              var map_points_with_num_sponsors = _.filter(map_points,
                                                    function(pt){
                                                        if (checkval == 0){
                                                            return pt.labelClass == '-'
                                                        } else {
                                                            sponsorcount=pt.labelClass.split(",").length;
                                                            return sponsorcount == checkval && pt.labelClass != '-'
                                                        }

                                                    });
              if (this.checked) {_.map(map_points_with_num_sponsors,function(pt) {
//                                console.log('checked');
                                pt.setMap(map);
                            });
                        } else {
                         _.map(map_points_with_num_sponsors,
                            function(pt) {
                                pt.setMap(null);
                            })}
                })

    });
    </script>
  </head>
  <body>
  <div class="form-inline">
    <div class="form-group">
        <div class="checkbox">
            <span class="filter"></span>
            </div>
        </div>
      </div>

    <div id="map-canvas"></div>
  </body>
</html>